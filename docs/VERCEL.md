# Vercel Production Deployment Guide

Complete setup instructions for deploying pastecn to Vercel with all required configurations.

---

## 1. Environment Variables

Configure these environment variables in the Vercel dashboard:

**Settings â†’ Environment Variables**

### Required Variables

```bash
# Blob Storage (automatically configured by Vercel)
BLOB_READ_WRITE_TOKEN=<auto-generated-by-vercel>

# JWT Secret for unlock sessions (CRITICAL: Change in production)
UNLOCK_SESSION_SECRET=<generate-strong-random-string>
```

**How to generate `UNLOCK_SESSION_SECRET`:**
```bash
# Option 1: Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# Option 2: OpenSSL
openssl rand -hex 32

# Option 3: Online (use trusted sources only)
# https://www.uuidgenerator.net/dev-tools/random-string-generator
```

### Optional Variables

```bash
# Site URL (default: https://pastecn.com)
NEXT_PUBLIC_SITE_URL=https://your-domain.com

# Session duration in hours (default: 24)
UNLOCK_SESSION_DURATION_HOURS=24

# Announcement Banner
NEXT_PUBLIC_ANNOUNCEMENT_ENABLED=true
NEXT_PUBLIC_ANNOUNCEMENT_TEXT="ðŸš€ We just launched pastecn!"
NEXT_PUBLIC_ANNOUNCEMENT_LINK_URL="https://github.com/rbadillap/pastecn"
NEXT_PUBLIC_ANNOUNCEMENT_LINK_TEXT="Star us on GitHub"
NEXT_PUBLIC_ANNOUNCEMENT_ID="pastecn-launch"
```

---

## 2. Vercel Blob Storage

**Status:** âœ… Auto-configured

Vercel Blob is automatically set up when you enable it in your project.

**To verify:**
1. Go to **Storage â†’ Blob**
2. Ensure blob storage is connected to your project
3. `BLOB_READ_WRITE_TOKEN` should be auto-generated

**Pricing:**
- Pro plan: Included
- Check current limits: https://vercel.com/docs/storage/vercel-blob/usage-and-pricing

---

## 3. Vercel Firewall - Rate Limiting

**Required for password protection feature**

### Setup Steps

1. **Navigate to Security:**
   - Project Settings â†’ Security â†’ Firewall

2. **Enable Firewall:**
   - Toggle "Enable Firewall"
   - Select pricing tier (requires Pro plan or higher)

3. **Configure Rate Limit Rules:**

   Create a new rule with these settings:

   **Rule Name:** `unlock-snippet-rate-limit`

   **Configuration:**
   ```yaml
   Action: Rate Limit
   Rate Limit Key: unlock-snippet
   Rate Limit: 5 requests per 15 minutes
   Scope: Per IP address
   Paths: /api/snippets/*/unlock
   ```

   **Alternatively, via vercel.json:**
   ```json
   {
     "firewall": [
       {
         "id": "unlock-snippet",
         "action": {
           "type": "rate-limit",
           "limit": 5,
           "window": "15m"
         }
       }
     ]
   }
   ```

### Rate Limiting Details

- **Endpoint:** `/api/snippets/[id]/unlock`
- **Limit:** 5 attempts per 15 minutes per IP
- **Purpose:** Prevent brute force attacks on protected snippets
- **Behavior:** Returns 429 (Too Many Requests) when exceeded

### Testing Rate Limiting

```bash
# Test locally (won't work - needs Vercel infrastructure)
# Deploy to preview first

# Test on preview deployment
for i in {1..6}; do
  curl -X POST https://your-preview.vercel.app/api/snippets/test-id/unlock \
    -H "Content-Type: application/json" \
    -d '{"password":"wrong"}'
  echo "\nAttempt $i"
done

# 6th attempt should return 429
```

---

## 4. Vercel Bot Protection (Optional but Recommended)

Adds additional security against automated attacks.

### Setup Steps

1. **Navigate to Security:**
   - Project Settings â†’ Security â†’ Attack Challenge Mode

2. **Enable Bot Protection:**
   - Select protection level:
     - **Moderate** (Recommended): Balance between security and UX
     - **Strong**: Maximum protection, may challenge legitimate users

3. **Configure Protected Routes:**
   - Protection applies automatically to all routes
   - Specifically benefits:
     - `/api/snippets/[id]/unlock` (password attempts)
     - `/api/snippets/upload` (snippet creation)

### How It Works

- Challenges suspicious traffic with CAPTCHA
- Uses behavioral analysis and fingerprinting
- Transparent for legitimate users
- Blocks automated bots and scrapers

---

## 5. Domain Configuration

### Custom Domain Setup

1. **Add Domain:**
   - Project Settings â†’ Domains
   - Add your custom domain (e.g., `pastecn.com`)

2. **Update Environment Variable:**
   ```bash
   NEXT_PUBLIC_SITE_URL=https://your-domain.com
   ```

3. **Configure DNS:**
   - Follow Vercel's DNS instructions
   - Usually: Add A/CNAME records to your DNS provider

4. **SSL Certificate:**
   - âœ… Automatically provisioned by Vercel
   - No action needed

---

## 6. Analytics Setup (Optional)

### Vercel Analytics

**Already configured in code:**
```typescript
import { track } from "@vercel/analytics/react"
```

**Enable in Vercel:**
1. Project Settings â†’ Analytics
2. Enable Vercel Analytics
3. Events tracked:
   - `snippet_viewed`
   - `snippet_uploaded`
   - `registry_accessed`
   - `registry_unauthorized`

---

## 7. Deployment Checklist

Before deploying to production, verify:

### Environment Variables
- [ ] `UNLOCK_SESSION_SECRET` set (strong random string)
- [ ] `NEXT_PUBLIC_SITE_URL` set to production domain
- [ ] `BLOB_READ_WRITE_TOKEN` auto-configured
- [ ] Optional variables configured as needed

### Security
- [ ] Vercel Firewall enabled
- [ ] Rate limiting rule created for `unlock-snippet`
- [ ] Bot Protection enabled (optional but recommended)
- [ ] Rate limit tested on preview deployment

### Storage
- [ ] Vercel Blob Storage connected
- [ ] Storage limits reviewed for expected usage

### Domain
- [ ] Custom domain added (if applicable)
- [ ] DNS configured correctly
- [ ] SSL certificate active

### Testing
- [ ] Preview deployment tested
- [ ] Password protection flow tested
- [ ] Rate limiting verified
- [ ] CLI authentication tested with production URL

---

## 8. Post-Deployment Verification

### Test Protected Snippets

1. **Create a protected snippet:**
   ```bash
   # Visit https://your-domain.com
   # Create snippet with password protection
   # Note the password and snippet ID
   ```

2. **Test web unlock:**
   ```bash
   # Open in incognito: https://your-domain.com/p/{snippet-id}
   # Verify metadata visible but code locked
   # Enter password and verify unlock
   ```

3. **Test CLI access:**
   ```bash
   # Without password (should fail)
   pnpm dlx shadcn@latest add https://your-domain.com/r/{snippet-id}

   # With password (should succeed)
   # Configure .env.local and components.json
   pnpm dlx shadcn@latest add @your-registry/{snippet-id}
   ```

4. **Test rate limiting:**
   ```bash
   # Make 6 failed unlock attempts rapidly
   # 6th attempt should return 429 Too Many Requests
   ```

---

## 9. Monitoring & Maintenance

### What to Monitor

**Vercel Dashboard:**
- Function invocations (check API usage)
- Blob storage usage and costs
- Firewall events (rate limit triggers)
- Error rates and logs

**Key Metrics:**
- Snippet upload rate
- Unlock attempt success/failure ratio
- Rate limit trigger frequency
- Average session duration

### Troubleshooting

**Issue:** Rate limiting not working
- Solution: Verify Firewall is enabled and rule is active
- Check: Firewall rules in Vercel dashboard

**Issue:** Snippets not saving
- Solution: Check `BLOB_READ_WRITE_TOKEN` is set
- Verify: Blob storage is connected to project

**Issue:** JWT errors
- Solution: Ensure `UNLOCK_SESSION_SECRET` is set and consistent
- Check: Variable is set in all environments (preview + production)

**Issue:** Bot attacks getting through
- Solution: Enable Bot Protection in moderate or strong mode
- Review: Firewall logs for patterns

---

## 10. Security Best Practices

### Regular Audits

- [ ] Review Firewall logs monthly
- [ ] Monitor for unusual unlock patterns
- [ ] Check for failed authentication spikes
- [ ] Audit blob storage for unusual activity

### Incident Response

**If you detect abuse:**

1. **Immediate Actions:**
   - Review Firewall logs for attacker IPs
   - Temporarily increase rate limiting (reduce to 3 attempts/15min)
   - Enable Strong Bot Protection mode

2. **Investigation:**
   - Check Analytics for anomalous patterns
   - Review failed unlock attempts by snippet ID
   - Identify targeted snippets

3. **Mitigation:**
   - Consider revoking compromised snippet IDs
   - Adjust rate limits based on attack pattern
   - Add custom Firewall rules for specific IPs (if needed)

### Recommended Settings

**For Public Use:**
- Session Duration: 24 hours
- Rate Limit: 5 attempts / 15 minutes
- Bot Protection: Moderate

**For Internal/Private Use:**
- Session Duration: 7 days (168 hours)
- Rate Limit: 10 attempts / 15 minutes
- Bot Protection: Disabled (if traffic is trusted)

**For High-Security Use:**
- Session Duration: 1 hour
- Rate Limit: 3 attempts / 15 minutes
- Bot Protection: Strong

---

## 11. Cost Estimation

### Vercel Pro Plan (Minimum Required)

**Base Costs:**
- Vercel Pro: $20/month per seat
- Blob Storage: Included (with limits)
- Firewall: Included (with limits)
- Bot Protection: Included

**Usage-Based Costs:**
- Blob Storage: $0.15/GB stored, $0.15/GB transferred
- Firewall: $10/month for additional rules (after free tier)
- Functions: Usage typically covered in Pro plan

**Estimated Monthly Cost for Moderate Traffic:**
- ~1000 snippets created: $0-2 (storage)
- ~10,000 snippet views: $0-5 (bandwidth)
- ~1,000 unlock attempts: Covered
- **Total: ~$20-30/month**

---

## 12. Support Resources

**Vercel Documentation:**
- Blob Storage: https://vercel.com/docs/storage/vercel-blob
- Firewall: https://vercel.com/docs/security/vercel-firewall
- Environment Variables: https://vercel.com/docs/projects/environment-variables

**pastecn Resources:**
- GitHub: https://github.com/rbadillap/pastecn
- Issues: https://github.com/rbadillap/pastecn/issues

**Need Help?**
- Check CHANGELOG.md for technical details
- Review code comments in `/app/api/snippets/` routes
- Open GitHub issue with deployment logs

---

## Quick Start Commands

```bash
# 1. Clone and install
git clone https://github.com/rbadillap/pastecn.git
cd pastecn
pnpm install

# 2. Deploy to Vercel
vercel

# 3. Set environment variables
vercel env add UNLOCK_SESSION_SECRET
# Paste generated secret

vercel env add UNLOCK_SESSION_DURATION_HOURS
# Enter: 24

# 4. Enable Firewall in Vercel Dashboard
# Settings â†’ Security â†’ Firewall â†’ Enable

# 5. Deploy to production
vercel --prod

# 6. Verify deployment
curl https://your-domain.com/api/health
```

---

**Last Updated:** 2025-01-23
**Version:** 1.0.0
**Requires:** Vercel Pro plan or higher
